

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Language Reference &mdash; gt_frontend 0.0.1.dev1 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="License" href="license.html" />
    <link rel="prev" title="gt_frontend package" href="_source/gt_frontend.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> gt_frontend
          

          
          </a>

          
            
            
              <div class="version">
                0.0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="guides/fvm/fvm.html">Finite-Volume-Method on Median-Dual Meshes</a></li>
<li class="toctree-l1"><a class="reference internal" href="apiref.html">API Documentation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Language Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#abstract">Abstract</a></li>
<li class="toctree-l2"><a class="reference internal" href="#motivation-and-scope">Motivation and Scope</a></li>
<li class="toctree-l2"><a class="reference internal" href="#concepts">Concepts</a></li>
<li class="toctree-l2"><a class="reference internal" href="#stencil">Stencil</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#types-variables">Types &amp; Variables</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#statements">Statements</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#assignments">Assignments</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#expressions">Expressions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#literals-constants">Literals / Constants</a></li>
<li class="toctree-l3"><a class="reference internal" href="#field-access">Field access</a></li>
<li class="toctree-l3"><a class="reference internal" href="#arithmetic-operators">Arithmetic operators</a></li>
<li class="toctree-l3"><a class="reference internal" href="#neighbor-reductions">Neighbor reductions</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="license.html">License</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">gt_frontend</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Language Reference</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/language_reference.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="language-reference">
<h1>Language Reference<a class="headerlink" href="#language-reference" title="Permalink to this headline">¶</a></h1>
<div class="section" id="abstract">
<h2>Abstract<a class="headerlink" href="#abstract" title="Permalink to this headline">¶</a></h2>
<p>This document contains a draft of the DSL syntax for GTScript on meshes.</p>
<p><strong>Design Goals</strong></p>
<ol class="arabic simple">
<li><p>Concise, compact and readable syntax</p></li>
<li><p>General enough to allow generation of efficient code for meshes with unstructured, partially structured, structured meshes</p></li>
<li><p>Easy to translate into GTScriptAST</p></li>
</ol>
</div>
<div class="section" id="motivation-and-scope">
<h2>Motivation and Scope<a class="headerlink" href="#motivation-and-scope" title="Permalink to this headline">¶</a></h2>
<p>For global weather models (e.g. <a class="reference external" href="https://refubium.fu-berlin.de/bitstream/handle/fub188/25122/K%C3%BChnlein_FVM_2019.pdf?sequence=1">IFS-FVM</a>, ICON) the ability to handle non-regular grids is required.</p>
</div>
<div class="section" id="concepts">
<h2>Concepts<a class="headerlink" href="#concepts" title="Permalink to this headline">¶</a></h2>
<p>This section is WIP and will be moved to the concepts repo when it matured.</p>
<p><strong>Location</strong></p>
<p>A bounded set with nonempty interior. We differentiate between horizontal locations, i.e. <code class="code docutils literal notranslate"><span class="pre">Cell</span></code>, <code class="code docutils literal notranslate"><span class="pre">Edge</span></code>, <code class="code docutils literal notranslate"><span class="pre">Vertex</span></code> and vertical locations, i.e. a layer. Each location can be attributed to a domain dimesion.</p>
<p><strong>Mesh</strong></p>
<p>A subdivision of the computational domain into locations.</p>
<p><strong>Field</strong></p>
<p>A mapping between locations and quantities at this location.</p>
<div class="math notranslate nohighlight">
\[f: (c_1, ..., c_n) \mapsto a\]</div>
<p><strong>Local field</strong></p>
<p>A field defined in the neighbourhood of a cell.</p>
<p><strong>Neighbourhood chain</strong></p>
<p>Used to select direct or indirect neighbours of a cell. See here <a class="reference external" href="https://docs.google.com/document/d/1nQZzKGi7Go9R3fme78ViB_PrQDVPxy4xTzSuGh_yJAI/edit">https://docs.google.com/document/d/1nQZzKGi7Go9R3fme78ViB_PrQDVPxy4xTzSuGh_yJAI/edit</a> for a description.</p>
<p>Todo: properly define concept and add illustrations.</p>
<p><strong>Primary location</strong></p>
<p>The location(s) a stencil is applied to.</p>
<p><strong>Secondary location</strong></p>
<p>The location on which operations on neighbours act on.</p>
</div>
<div class="section" id="stencil">
<h2>Stencil<a class="headerlink" href="#stencil" title="Permalink to this headline">¶</a></h2>
<p>The entry point into GTScript code is a stencil, giving the user a local perspective on the mesh. The syntax to define a stencil follows the regular python syntax to define functions with an additional <code class="code docutils literal notranslate"><span class="pre">&#64;gtscript.stencil</span></code> decorator, where the first function argument is the <code class="code docutils literal notranslate"><span class="pre">Mesh</span></code> followed by a set of <code class="code docutils literal notranslate"><span class="pre">Field</span></code> s.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@gtscript</span><span class="o">.</span><span class="n">stencil</span>
<span class="k">def</span> <span class="nf">stencil_name</span><span class="p">(</span><span class="n">mesh</span><span class="p">:</span> <span class="n">Mesh</span><span class="p">,</span> <span class="n">my_field</span> <span class="p">:</span> <span class="n">Field</span><span class="p">[[</span><span class="n">Vertex</span><span class="p">],</span> <span class="n">dtype</span><span class="p">]):</span>
  <span class="c1"># ...</span>
</pre></div>
</div>
<p><strong>Computations</strong></p>
<p>The stencils body is composed of one or more computations specifying the iteration domain. The iteration domain is split into horizontal and vertical iteration domains. The vertical iteration domain, which is 1D, can have different policies: FORWARD, BACKWARD and PARALLEL, indicating the order constraints of the iteration. The horizontal iteration domain is of 2-dimensional nature with one unstructured dimension representing the geometrically 2-dimensional horizontal plane. There is only one horizontal iteration policy and it is always PARALLEL, so it is not specified. Statements are executed as specified in the <a class="reference external" href="https://github.com/GridTools/concepts/wiki/GTScript-Parallel-model">GTScript parallel model</a></p>
<p>Computations are expressed (syntactically) using <code class="code docutils literal notranslate"><span class="pre">with</span></code> statements and the three iteration specifications <code class="code docutils literal notranslate"><span class="pre">computation</span></code>, <code class="code docutils literal notranslate"><span class="pre">interval</span></code> and <code class="code docutils literal notranslate"><span class="pre">location</span></code>.</p>
<ul>
<li><p><code class="code docutils literal notranslate"><span class="pre">computation(iteration</span> <span class="pre">order)</span></code></p>
<p>Specifies the iteration order in the vertical dimension, where <code class="code docutils literal notranslate"><span class="pre">iteration_policy</span></code> is one of: <code class="code docutils literal notranslate"><span class="pre">PARALLEL</span></code>, <code class="code docutils literal notranslate"><span class="pre">FORWARD</span></code>, <code class="code docutils literal notranslate"><span class="pre">BACKWARD</span></code></p>
</li>
<li><p><code class="code docutils literal notranslate"><span class="pre">location(location_type)</span></code></p>
<p>Restricts the horizontal dimension to locations of type <code class="code docutils literal notranslate"><span class="pre">location_type</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">location</span><span class="p">(</span><span class="n">Vertex</span><span class="p">)</span>
<span class="n">location</span><span class="p">(</span><span class="n">Edge</span><span class="p">)</span>
<span class="n">location</span><span class="p">(</span><span class="n">Cell</span><span class="p">)</span>
</pre></div>
</div>
<p>Locations may be labeled to reference them in neighbor reductions later on as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">location</span><span class="p">(</span><span class="n">Vertex</span><span class="p">)</span> <span class="k">as</span> <span class="n">v</span><span class="p">:</span>
  <span class="c1"># ...</span>
</pre></div>
</div>
</li>
<li><p><code class="code docutils literal notranslate"><span class="pre">interval(start,</span> <span class="pre">end)</span></code>:</p>
<p>Restricts the vertical dimension to the interval <span class="math notranslate nohighlight">\([start, end[\)</span>, i.e. an interval including <code class="code docutils literal notranslate"><span class="pre">start</span></code> and excluding <code class="code docutils literal notranslate"><span class="pre">end</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">interval</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>      <span class="c1"># layer 0 and 1</span>
<span class="n">interval</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>     <span class="c1"># all layers except for the last</span>
<span class="n">interval</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># only the last layer</span>
</pre></div>
</div>
</li>
</ul>
<p>The skeleton of a stencil <code class="code docutils literal notranslate"><span class="pre">my_stencil</span></code> with a single field argument <code class="code docutils literal notranslate"><span class="pre">my_field</span></code> defined on vertices, executing concurrently on all vertices, accross all layers then looks as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@gtscript</span><span class="o">.</span><span class="n">stencil</span>
<span class="k">def</span> <span class="nf">my_stencil</span><span class="p">(</span><span class="n">mesh</span><span class="p">:</span> <span class="n">Mesh</span><span class="p">):</span>
  <span class="k">with</span> <span class="n">computation</span><span class="p">(</span><span class="n">PARALLEL</span><span class="p">),</span> <span class="n">location</span><span class="p">(</span><span class="n">Vertex</span><span class="p">),</span> <span class="n">interval</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
    <span class="c1"># ...</span>
</pre></div>
</div>
<p>The iteration specifications may also be nested as long as their order is <code class="code docutils literal notranslate"><span class="pre">computation</span></code>, <code class="code docutils literal notranslate"><span class="pre">location</span></code>, <code class="code docutils literal notranslate"><span class="pre">interval</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@gtscript</span><span class="o">.</span><span class="n">stencil</span>
<span class="k">def</span> <span class="nf">my_stencil</span><span class="p">(</span><span class="n">mesh</span><span class="p">:</span> <span class="n">Mesh</span><span class="p">):</span>
  <span class="k">with</span> <span class="n">computation</span><span class="p">(</span><span class="n">PARALLEL</span><span class="p">):</span>   <span class="c1"># vertical iteration policy</span>
    <span class="k">with</span> <span class="n">location</span><span class="p">(</span><span class="n">Vertex</span><span class="p">):</span>   <span class="c1"># location specification</span>
      <span class="k">with</span> <span class="n">interval</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>       <span class="c1"># vertical interval</span>
        <span class="c1"># ...</span>
</pre></div>
</div>
<p>A stencil running different computations on the first, last and the layers in between could then look as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@gtscript</span><span class="o">.</span><span class="n">stencil</span>
<span class="k">def</span> <span class="nf">my_stencil</span><span class="p">(</span><span class="n">mesh</span><span class="p">:</span> <span class="n">Mesh</span><span class="p">):</span>
  <span class="k">with</span> <span class="n">computation</span><span class="p">(</span><span class="n">PARALLEL</span><span class="p">):</span>   <span class="c1"># vertical iteration policy</span>
    <span class="k">with</span> <span class="n">location</span><span class="p">(</span><span class="n">Vertex</span><span class="p">):</span>   <span class="c1"># location specification</span>
      <span class="k">with</span> <span class="n">interval</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1"># statements executed on the first layer</span>
        <span class="c1"># ...</span>
      <span class="k">with</span> <span class="n">interval</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># statements executed on all, but the first and last layer</span>
        <span class="c1"># ...</span>
      <span class="k">with</span> <span class="n">interval</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1"># statements executed on the last layer</span>
        <span class="c1"># ...</span>
</pre></div>
</div>
<p>The specification of the iteration policy and interval may also be skipped in which case the default iteration policy is <code class="code docutils literal notranslate"><span class="pre">PARALLEL</span></code> and all layers are considered.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@gtscript</span><span class="o">.</span><span class="n">stencil</span>
<span class="k">def</span> <span class="nf">my_stencil</span><span class="p">(</span><span class="n">mesh</span><span class="p">:</span> <span class="n">Mesh</span><span class="p">):</span>
  <span class="k">with</span> <span class="n">location</span><span class="p">(</span><span class="n">Vertex</span><span class="p">):</span>
    <span class="c1"># ...</span>
  <span class="k">with</span> <span class="n">location</span><span class="p">(</span><span class="n">Edge</span><span class="p">):</span>
    <span class="c1"># ...</span>
</pre></div>
</div>
<p>Todo: Incorporate sparse fields syntax</p>
<div class="section" id="types-variables">
<h3>Types &amp; Variables<a class="headerlink" href="#types-variables" title="Permalink to this headline">¶</a></h3>
<p>GTScript only supports the following limited set of types. All variables are required to be of fixed type throughout the stencil.</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="code docutils literal notranslate"><span class="pre">Field[[*DIMS],</span> <span class="pre">V]</span></code></p></td>
<td><p>A mapping between locations with their attributed dimensions <code class="code docutils literal notranslate"><span class="pre">DIMS</span></code> and quantaties of type <code class="code docutils literal notranslate"><span class="pre">V</span></code> at this location.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="code docutils literal notranslate"><span class="pre">Mesh</span></code></p></td>
<td><p>A discrete representation of the computational domain (passed as first argument to the stencil call).</p></td>
</tr>
<tr class="row-even"><td><p><code class="code docutils literal notranslate"><span class="pre">LocationType</span></code></p></td>
<td><p>The type of a location, i.e. <code class="code docutils literal notranslate"><span class="pre">Cell</span></code>, <code class="code docutils literal notranslate"><span class="pre">Edge</span></code>, <code class="code docutils literal notranslate"><span class="pre">Vertex</span></code>.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="code docutils literal notranslate"><span class="pre">Location[T]</span></code></p></td>
<td><p>A location, i.e. a specific cell, edge or vertex, where <code class="code docutils literal notranslate"><span class="pre">T</span></code> is a <code class="code docutils literal notranslate"><span class="pre">LocationType</span></code>. Locations can only be constructed in <code class="code docutils literal notranslate"><span class="pre">LocationSpecifications</span></code> or <code class="code docutils literal notranslate"><span class="pre">LocationComprehensions</span></code>.</p></td>
</tr>
<tr class="row-even"><td><p><code class="code docutils literal notranslate"><span class="pre">DataType</span></code></p></td>
<td><dl class="simple">
<dt>A scalar value</dt><dd><ul class="simple">
<li><p><code class="code docutils literal notranslate"><span class="pre">bool</span></code></p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">int</span></code></p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">float</span></code></p></li>
</ul>
</dd>
</dl>
</td>
</tr>
</tbody>
</table>
<p>Variable types:</p>
<ul class="simple">
<li><p><code class="code docutils literal notranslate"><span class="pre">Field</span></code></p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">TemporaryField</span></code></p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">Location</span></code></p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">Mesh</span></code></p></li>
</ul>
<p>Todo: Expand &amp; seperate variable and type documentation.</p>
</div>
</div>
<div class="section" id="statements">
<h2>Statements<a class="headerlink" href="#statements" title="Permalink to this headline">¶</a></h2>
<p>The only statements allowed are assignments.</p>
<div class="section" id="assignments">
<h3>Assignments<a class="headerlink" href="#assignments" title="Permalink to this headline">¶</a></h3>
<p>The left-hand-side of an assignment is always a <code class="code docutils literal notranslate"><span class="pre">Field</span></code> defined on the current iteration space. If the field is not passed as a stencil argument, a temporary field is automatically introduced and may be referenced throughout the entire stencil. The right-hand-side of an assignment is an expression with type <code class="code docutils literal notranslate"><span class="pre">DataType</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">field</span> <span class="o">=</span> <span class="n">expression</span>
<span class="n">field</span><span class="p">[</span><span class="n">location</span><span class="p">]</span> <span class="o">=</span> <span class="n">expression</span>
</pre></div>
</div>
<p>Modified example of the copy stencil emphasizing the behaviour of temporary fields:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@gtscript</span><span class="o">.</span><span class="n">stencil</span>
<span class="k">def</span> <span class="nf">tmp_field_copy</span><span class="p">(</span>
  <span class="n">mesh</span><span class="p">:</span> <span class="n">Mesh</span><span class="p">,</span>
  <span class="n">field_in</span> <span class="p">:</span> <span class="n">Field</span><span class="p">[[</span><span class="n">Vertex</span><span class="p">],</span> <span class="nb">float</span><span class="p">],</span>
  <span class="n">field_out</span> <span class="p">:</span> <span class="n">Field</span><span class="p">[[</span><span class="n">Vertex</span><span class="p">],</span> <span class="nb">float</span><span class="p">]</span>
<span class="p">):</span>
    <span class="k">with</span> <span class="n">location</span><span class="p">(</span><span class="n">Vertex</span><span class="p">)</span> <span class="k">as</span> <span class="n">v</span><span class="p">:</span>
      <span class="n">tmp_field</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_in</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
    <span class="k">with</span> <span class="n">location</span><span class="p">(</span><span class="n">Vertex</span><span class="p">)</span> <span class="k">as</span> <span class="n">v</span><span class="p">:</span>
      <span class="n">field_out</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_field</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
</pre></div>
</div>
<p>Todo: Off-center writes</p>
</div>
</div>
<div class="section" id="expressions">
<h2>Expressions<a class="headerlink" href="#expressions" title="Permalink to this headline">¶</a></h2>
<div class="section" id="literals-constants">
<h3>Literals / Constants<a class="headerlink" href="#literals-constants" title="Permalink to this headline">¶</a></h3>
<p>Only boolean and numeric literals are allowed. The precision of numeric literals is contrary to python by default machine-independent, but may be overridden by the user by specifying the <code class="code docutils literal notranslate"><span class="pre">dtype</span></code> stencil decorator argument.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># booleans are always of type bool</span>
<span class="kc">True</span>
<span class="kc">False</span>
<span class="c1"># integer are of type dtypes[&quot;int&quot;]</span>
<span class="mi">3</span>
<span class="c1"># float are of type dtypes[&quot;float&quot;]</span>
<span class="mf">3.</span>
</pre></div>
</div>
<p>The user may for example use 32 bit float and integer values for all literals of a stencil as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@gtscript</span><span class="o">.</span><span class="n">stencil</span><span class="p">(</span><span class="n">dtypes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;float&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="s2">&quot;int&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">my_stencil</span><span class="p">(</span><span class="n">mesh</span><span class="p">:</span> <span class="n">gtscript</span><span class="o">.</span><span class="n">Mesh</span><span class="p">):</span>
  <span class="k">with</span> <span class="n">location</span><span class="p">(</span><span class="n">Vertex</span><span class="p">)</span> <span class="k">as</span> <span class="n">v</span><span class="p">:</span>
      <span class="n">my_field</span> <span class="o">=</span> <span class="n">my_field</span> <span class="o">+</span> <span class="mf">1.1</span> <span class="c1"># 32 bit approximation of 1.1 used</span>
      <span class="n">my_field</span> <span class="o">=</span> <span class="n">my_field</span> <span class="o">+</span> <span class="mi">1</span>   <span class="c1"># 32 bit integer with value 1 used</span>
</pre></div>
</div>
<p>The user may further explicitly specify the type of a literal using regular instantiation syntax, e.g. <code class="code docutils literal notranslate"><span class="pre">float32(&quot;1.1&quot;)</span></code> for a float with 32 bits of precision.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Integer</span>
<span class="n">uint32</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
<span class="n">uint64</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
<span class="n">int32</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
<span class="n">int64</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
<span class="c1"># Floating point</span>
<span class="n">float32</span><span class="p">(</span><span class="s2">&quot;1.1&quot;</span><span class="p">)</span>
<span class="n">float64</span><span class="p">(</span><span class="s2">&quot;1.1&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This allows for usage of literals with mixed precision.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@gtscript</span><span class="o">.</span><span class="n">stencil</span><span class="p">(</span><span class="n">dtypes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;float&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">my_stencil</span><span class="p">(</span><span class="n">mesh</span><span class="p">:</span> <span class="n">gtscript</span><span class="o">.</span><span class="n">Mesh</span><span class="p">):</span>
  <span class="k">with</span> <span class="n">location</span><span class="p">(</span><span class="n">Vertex</span><span class="p">)</span> <span class="k">as</span> <span class="n">v</span><span class="p">:</span>
      <span class="n">my_field</span> <span class="o">=</span> <span class="n">my_field</span> <span class="o">+</span> <span class="mf">1.1</span> <span class="o">+</span> <span class="n">float64</span><span class="p">(</span><span class="s2">&quot;1.1&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="field-access">
<h3>Field access<a class="headerlink" href="#field-access" title="Permalink to this headline">¶</a></h3>
<p>Fields are accessed using the subscript operator <code class="code docutils literal notranslate"><span class="pre">[]</span></code> with the index being the location to be accessed and a vertical offset. If no subscript is provided the value at the current location and layer is retrieved.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">field</span>        <span class="c1"># value at the current primary location and layer</span>
<span class="n">field</span><span class="p">[</span><span class="n">v</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># value at the current layer and location `v`</span>
<span class="n">field</span><span class="p">[</span><span class="n">v</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># value at location `v` with vertical offset -1</span>
</pre></div>
</div>
</div>
<div class="section" id="arithmetic-operators">
<h3>Arithmetic operators<a class="headerlink" href="#arithmetic-operators" title="Permalink to this headline">¶</a></h3>
<p>Arithmetic operators on values of type <code class="code docutils literal notranslate"><span class="pre">gtc.common.DataType</span></code> follow the regular python syntax.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
<span class="n">a</span> <span class="o">-</span> <span class="n">b</span>
<span class="n">a</span> <span class="o">*</span> <span class="n">b</span>
<span class="n">a</span> <span class="o">/</span> <span class="n">b</span>
</pre></div>
</div>
</div>
<div class="section" id="neighbor-reductions">
<h3>Neighbor reductions<a class="headerlink" href="#neighbor-reductions" title="Permalink to this headline">¶</a></h3>
<p>Reductions over neighbors are composed of a reduction function, a generator expression, representing a set of values on the neighboring locations, and a neighbor selector, specifying the neighbors to be reduced over. GTScript supports four reduction functions <code class="code docutils literal notranslate"><span class="pre">sum</span></code>, <code class="code docutils literal notranslate"><span class="pre">product</span></code>, <code class="code docutils literal notranslate"><span class="pre">min</span></code>, <code class="code docutils literal notranslate"><span class="pre">max</span></code>, computing the sum, product, mimimum and maximum, respectively, of its arguments. The argument to a reduction function is a generator expression with the following syntax:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">expression</span> <span class="k">for</span> <span class="n">location</span> <span class="ow">in</span> <span class="n">neighbor_selector</span>
</pre></div>
</div>
<p>where <code class="code docutils literal notranslate"><span class="pre">expression</span></code> is just an expression, <code class="code docutils literal notranslate"><span class="pre">location</span></code> the name of the symbol referencing the neighbors location and <code class="code docutils literal notranslate"><span class="pre">neighbor_selector</span></code> is a neighbor selector. Inside the expression, fields may be referenced using <code class="code docutils literal notranslate"><span class="pre">location</span></code>. Neighbors of the primary location can be selected via calls to the built-in function <code class="code docutils literal notranslate"><span class="pre">neighbors</span></code> or one of the convenience functions <cite>vertices</cite> and <cite>edges</cite>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># signature</span>
<span class="n">neighbors</span><span class="p">(</span><span class="n">primary_location</span> <span class="p">:</span> <span class="n">Location</span><span class="p">,</span> <span class="o">*</span><span class="n">chain</span> <span class="p">:</span> <span class="n">LocationType</span><span class="p">)</span>

<span class="c1"># select all cells sharing a common vertex with the current `cell`</span>
<span class="n">neighbors</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">Vertex</span><span class="p">,</span> <span class="n">Cell</span><span class="p">)</span>
</pre></div>
</div>
<p>Pseudo-code for <code class="code docutils literal notranslate"><span class="pre">vertices</span></code> and <code class="code docutils literal notranslate"><span class="pre">edges</span></code> convenience functions:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">vertices</span><span class="p">(</span><span class="n">of</span> <span class="p">:</span> <span class="n">Location</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">neighbors</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">Vertex</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">edges</span><span class="p">(</span><span class="n">of</span> <span class="p">:</span> <span class="n">Location</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">neighbors</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">Edge</span><span class="p">)</span>
</pre></div>
</div>
<p>Example computing the sum of <code class="code docutils literal notranslate"><span class="pre">vertex_field</span></code> over all neighboring vertices of <code class="code docutils literal notranslate"><span class="pre">e</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">sum</span><span class="p">(</span><span class="n">vertex_field</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vertices</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
<span class="n">product</span><span class="p">(</span><span class="n">vertex_field</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vertices</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</pre></div>
</div>
<p>Todo: Sparse field example</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="license.html" class="btn btn-neutral float-right" title="License" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="_source/gt_frontend.html" class="btn btn-neutral float-left" title="gt_frontend package" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, ETH Zurich

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>